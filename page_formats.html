<!-- HTML header for doxygen 1.8.10-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<title>librsync: File formats</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
    <!-- ad -->
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <!-- librsync -->
    <ins class="adsbygoogle"
         style="display:block"
         data-ad-client="ca-pub-3547096055927362"
         data-ad-slot="8322976738"
         data-ad-format="auto"></ins>
    <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">librsync
   &#160;<span id="projectnumber">2.3.2</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">File formats </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_doc_format"></a> </p>
<h1><a class="anchor" id="autotoc_md49"></a>
Generalities</h1>
<p>There are two file formats used by <code>librsync</code> and <code>rdiff</code>: the <em>signature</em> file, which summarizes a data file, and the <em>delta</em> file, which describes the edits from one data file to another.</p>
<p>librsync does not know or care about any formats in the data files.</p>
<p>All integers are big-endian.</p>
<h1><a class="anchor" id="autotoc_md50"></a>
Magic numbers</h1>
<p>All librsync files start with a u32 <a class="el" href="librsync_8h.html#ab6abafd1db0a3947bb3c076507f4f7c2">rs_magic_number</a> identifying them. These are declared in <code><a class="el" href="librsync_8h.html" title="Public header for librsync.">librsync.h</a></code>, and there are different numbers for every different signature and delta file type. Note magic numbers for newer file types are not supported by older versions of librsync. Older librsync versions will immediately fail with an error when they encounter file types they don't support.</p>
<h1><a class="anchor" id="autotoc_md51"></a>
Signatures</h1>
<p>Signatures consist of a header followed by a number of block signatures for each block in the data file.</p>
<p>The signature header is: </p><pre class="fragment">u32 magic;     // Some RS_*_SIG_MAGIC value.
u32 block_len; // Bytes per block.
u32 strong_sum_len;  // Bytes per strong sum in each block.
</pre><p> Each block signature includes a weaksum followed by a truncated strongsum hash for one block of <code>block_len</code> bytes from the input data file. The strongsum signature will be truncated to the <code>strong_sum_len</code> in the header. The final data block may be shorter. The number of blocks in the signature is therefore </p><pre class="fragment">ceil(input_len/block_len)
</pre><p> The block signature weak checksum is used as a rolling checksum to find moved data, and a strong hash used to check the match is correct. The weak checksum is either a rollsum (based on adler32) or (better alternative) rabinkarp, and the strong hash is either MD4 or BLAKE2 depending on the magic number.</p>
<p>Truncating the strongsum makes the signatures smaller at a cost of a greater chance of collisions. The strongsums are truncated by keeping the left most (first) bytes after computation.</p>
<p>Each signature block format is (see <code>rs_sig_do_block</code>): </p><pre class="fragment">u32 weak_sum;
u8[strong_sum_len] strong_sum;
</pre> <h1><a class="anchor" id="autotoc_md52"></a>
Delta files</h1>
<p>Deltas consist of the delta magic constant <code>RS_DELTA_MAGIC</code> followed by a series of commands. Commands tell the patch logic how to construct the result file (new version) from the basis file (old version).</p>
<p>There are three kinds of commands: the literal command, the copy command, and the end command. A command consists of a single byte followed by zero or more arguments. The number and size of the arguments are defined in <code><a class="el" href="prototab_8c.html" title="Delta file commands.">prototab.c</a></code>.</p>
<p>A literal command describes data not present in the basis file. It has one argument: <code>length</code>. The format is: </p><pre class="fragment">u8 command; // in the range 0x41 through 0x44 inclusive
u8[arg1_len] length;
u8[length] data; // new data to append
</pre><p> A copy command describes a range of data in the basis file. It has two arguments: <code>start</code> and <code>length</code>. The format is: </p><pre class="fragment">u8 command; // in the range 0x45 through 0x54 inclusive
u8[arg1_len] start; // offset in the basis to begin copying data
u8[arg2_len] length; // number of bytes to copy from the basis
</pre><p> The end command indicates the end of the delta file. It consists of a single null byte and has no arguments. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.8.10-->
<!-- start footer part -->
<!-- ad -->
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- librsync -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3547096055927362"
     data-ad-slot="8322976738"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<!-- analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-71109100-1', 'auto');
  ga('send', 'pageview');
</script>
<hr class="footer"/><address class="footer"><small>
Generated on Sat Apr 10 2021 15:04:34 for librsync by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.9.1
</small></address>
</body>
</html>
